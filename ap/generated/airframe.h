/* This file has been generated from /home/qq/paparazzi/conf/airframes/untested/hex_naze32.xml */
/* Version v5.8.1_stable-0-ga7c97e1 */
/* Please DO NOT EDIT */

#ifndef AIRFRAME_H
#define AIRFRAME_H

#define AIRFRAME_NAME "NAZE32"
#define AC_ID 1
#define MD5SUM ((uint8_t*)"\064\261\340\233\314\050\253\361\270\002\276\223\020\355\257\327")

#define USE_USB_SERIAL	1

#define PPRZ_VER_MAJOR 					5
#define PPRZ_VER_MINOR					8
#define PPRZ_VER_PATCH					1

#define PPRZ_TRIG_INT_COMPR_FLASH		
#define PPRZ_TRIG_INT_COMPR_HIGHEST

#define MODULE_HMC58XX_UPDATE_AHRS		1
#define RADIO_CONTROL
#define DATALINK						1
#define DOWNLINK						1

#define STABILIZATION_ATTITUDE_TYPE_INT

#define PERIPHERALS_AUTO_INIT

//#define	GPS_LED						1
#define BARO_LED						1
#define SYS_TIME_LED					2

#define USE_IMU							1
#define USE_AHRS						1
#define USE_AHRS_ALIGNER				1

#define USE_LED
#define USE_ADC							1
#define USE_GPS							1
#define USE_I2C1						1
#define USE_I2C2						1
#define USE_UART1						1
#define USE_UART2						1
#define USE_MOTOR_MIXING				1
#define USE_MAGNETOMETER				1
#define AHRS_USE_GPS_HEADING			1
#define USE_BARO_BOARD					1
//#define MODULE_HMC58XX_SYNC_SEND		1
#define PERIODIC_TELEMETRY				1

#define UART1_BAUD						57600
#define UART2_BAUD						115200

#define PERIODIC_FREQUENCY				512
#define TELEMETRY_FREQUENCY				512
#define MODULES_FREQUENCY				512
#define BARO_PERIODIC_FREQUENCY			50

#define IMU_GYRO_P_SENS_NUM 			4359
#define IMU_GYRO_P_SENS_DEN 			1000
#define IMU_GYRO_Q_SENS_NUM				4359
#define IMU_GYRO_Q_SENS_DEN				1000
#define IMU_GYRO_R_SENS_NUM 			4359
#define IMU_GYRO_R_SENS_DEN 			1000
#define IMU_ACCEL_X_SENS_NUM			4905
#define IMU_ACCEL_X_SENS_DEN 			1000
#define IMU_ACCEL_Y_SENS_NUM			4905
#define IMU_ACCEL_Y_SENS_DEN 			1000
#define IMU_ACCEL_Z_SENS_NUM 			4905
#define IMU_ACCEL_Z_SENS_DEN			1000

//#define AHRS_H_X 						0.3770441
//#define AHRS_H_Y 						0.0193986
//#define AHRS_H_Z 						0.9259921
#define AHRS_H_X 						1
#define AHRS_H_Y 						0
#define AHRS_H_Z 						0

/** default mag sensitivy and neutral from the datasheet
 * hmc5833 has 1090 LSB/(Gauss) at +-1.3 Ga range
 * sens = 1/1090 * 0.3Gauss * 2^INT32_MAG_FRAC
 * sens = 1/1090 * 0.3Gauss * 2048 = 0.56058
 */
/*
#define IMU_MAG_X_SENS					0.561
#define IMU_MAG_X_SENS_NUM				561
#define IMU_MAG_X_SENS_DEN 				1000
#define IMU_MAG_Y_SENS_NUM				561
#define IMU_MAG_Y_SENS_DEN 				1000
#define IMU_MAG_Z_SENS_NUM 				561
#define IMU_MAG_Z_SENS_DEN				1000
*/

#define IMU_MAG_X_NEUTRAL 225
#define IMU_MAG_Y_NEUTRAL -540
#define IMU_MAG_Z_NEUTRAL -66
#define IMU_MAG_X_SENS 4.93406235552
#define IMU_MAG_X_SENS_NUM 30231
#define IMU_MAG_X_SENS_DEN 6127
#define IMU_MAG_Y_SENS 4.71292903001
#define IMU_MAG_Y_SENS_NUM 28287
#define IMU_MAG_Y_SENS_DEN 6002
#define IMU_MAG_Z_SENS 5.35439319274
#define IMU_MAG_Z_SENS_NUM 18221
#define IMU_MAG_Z_SENS_DEN 3403

#define DefaultInsImpl 					ins_int
#define DOWNLINK_TRANSPORT				pprz_tp
#define GPS_LINK						uart2
#define DOWNLINK_DEVICE					uart1
#define PPRZ_UART						uart1
#define IMU_MPU60X0_I2C_DEV				i2c1
#define MAG_HMC58XX_I2C_DEV				i2c1
#define BB_MS5611_I2C_DEV				i2c1
#define BB_BMP280_I2C_DEV				i2c1

#define BOARD_CONFIG					"boards/naze32_rev5.h"
#define RADIO_CONTROL_TYPE_H 			"subsystems/radio_control/ppm.h"
#define STABILIZATION_ATTITUDE_TYPE_H	"stabilization/stabilization_attitude_quat_int.h"

#define SERVOS_PWM_NB 4
#include "subsystems/actuators/actuators_pwm.h"

#if 0
#define SERVO_FR 0
#define SERVO_FR_NEUTRAL 100
#define SERVO_FR_TRAVEL_UP 0.09375
#define SERVO_FR_TRAVEL_UP_NUM 1
#define SERVO_FR_TRAVEL_UP_DEN 4
#define SERVO_FR_TRAVEL_DOWN 0.0104166666667
#define SERVO_FR_TRAVEL_DOWN_NUM 1
#define SERVO_FR_TRAVEL_DOWN_DEN 96
#define SERVO_FR_MAX 2500
#define SERVO_FR_MIN 0

#define SERVO_BR 1
#define SERVO_BR_NEUTRAL 100
#define SERVO_BR_TRAVEL_UP 0.09375
#define SERVO_BR_TRAVEL_UP_NUM 1
#define SERVO_BR_TRAVEL_UP_DEN 4
#define SERVO_BR_TRAVEL_DOWN 0.0104166666667
#define SERVO_BR_TRAVEL_DOWN_NUM 1
#define SERVO_BR_TRAVEL_DOWN_DEN 96
#define SERVO_BR_MAX 2500
#define SERVO_BR_MIN 0

#define SERVO_BL 2
#define SERVO_BL_NEUTRAL 100
#define SERVO_BL_TRAVEL_UP 0.09375
#define SERVO_BL_TRAVEL_UP_NUM 1
#define SERVO_BL_TRAVEL_UP_DEN 4
#define SERVO_BL_TRAVEL_DOWN 0.0104166666667
#define SERVO_BL_TRAVEL_DOWN_NUM 1
#define SERVO_BL_TRAVEL_DOWN_DEN 96
#define SERVO_BL_MAX 2500
#define SERVO_BL_MIN 0

#define SERVO_FL 3
#define SERVO_FL_NEUTRAL 100
#define SERVO_FL_TRAVEL_UP 0.09375
#define SERVO_FL_TRAVEL_UP_NUM 1
#define SERVO_FL_TRAVEL_UP_DEN 4
#define SERVO_FL_TRAVEL_DOWN 0.0104166666667
#define SERVO_FL_TRAVEL_DOWN_NUM 1
#define SERVO_FL_TRAVEL_DOWN_DEN 96
#define SERVO_FL_MAX 2500
#define SERVO_FL_MIN 0

#else

#define SERVO_FR 0
#define SERVO_FR_NEUTRAL 1000
#define SERVO_FR_TRAVEL_UP 0.09375
#define SERVO_FR_TRAVEL_UP_NUM 3
#define SERVO_FR_TRAVEL_UP_DEN 32
#define SERVO_FR_TRAVEL_DOWN 0.0104166666667
#define SERVO_FR_TRAVEL_DOWN_NUM 1
#define SERVO_FR_TRAVEL_DOWN_DEN 96
#define SERVO_FR_MAX 1900
#define SERVO_FR_MIN 950

#define SERVO_BR 1
#define SERVO_BR_NEUTRAL 1000
#define SERVO_BR_TRAVEL_UP 0.09375
#define SERVO_BR_TRAVEL_UP_NUM 3
#define SERVO_BR_TRAVEL_UP_DEN 32
#define SERVO_BR_TRAVEL_DOWN 0.0104166666667
#define SERVO_BR_TRAVEL_DOWN_NUM 1
#define SERVO_BR_TRAVEL_DOWN_DEN 96
#define SERVO_BR_MAX 1900
#define SERVO_BR_MIN 950

#define SERVO_BL 2
#define SERVO_BL_NEUTRAL 1000
#define SERVO_BL_TRAVEL_UP 0.09375
#define SERVO_BL_TRAVEL_UP_NUM 3
#define SERVO_BL_TRAVEL_UP_DEN 32
#define SERVO_BL_TRAVEL_DOWN 0.0104166666667
#define SERVO_BL_TRAVEL_DOWN_NUM 1
#define SERVO_BL_TRAVEL_DOWN_DEN 96
#define SERVO_BL_MAX 1900
#define SERVO_BL_MIN 950

#define SERVO_FL 3
#define SERVO_FL_NEUTRAL 1000
#define SERVO_FL_TRAVEL_UP 0.09375
#define SERVO_FL_TRAVEL_UP_NUM 3
#define SERVO_FL_TRAVEL_UP_DEN 32
#define SERVO_FL_TRAVEL_DOWN 0.0104166666667
#define SERVO_FL_TRAVEL_DOWN_NUM 1
#define SERVO_FL_TRAVEL_DOWN_DEN 96
#define SERVO_FL_MAX 1900
#define SERVO_FL_MIN 950

#endif

#define COMMAND_ROLL 0
#define COMMAND_PITCH 1
#define COMMAND_YAW 2
#define COMMAND_THRUST 3
#define COMMANDS_NB 4
#define COMMANDS_FAILSAFE {0,0,0,0}


#define SECTION_MIXING 1
#define MOTOR_MIXING_TRIM_ROLL 0
#define MOTOR_MIXING_TRIM_PITCH 0
#define MOTOR_MIXING_TRIM_YAW 0
#define MOTOR_MIXING_NB_MOTOR 4
#define MOTOR_MIXING_SCALE 256


#define SECTION_MIXING 1
#define MOTOR_MIXING_TYPE QUAD_X
//#define MOTOR_MIXING_REVERSE 1

#define SERVO_FL_IDX 3
#define Set_FL_Servo(_v) { \
  actuators[SERVO_FL_IDX] = Chop(_v, SERVO_FL_MIN, SERVO_FL_MAX); \
  ActuatorPwmSet(SERVO_FL, actuators[SERVO_FL_IDX]); \
}

#define SERVO_BL_IDX 2
#define Set_BL_Servo(_v) { \
  actuators[SERVO_BL_IDX] = Chop(_v, SERVO_BL_MIN, SERVO_BL_MAX); \
  ActuatorPwmSet(SERVO_BL, actuators[SERVO_BL_IDX]); \
}

#define SERVO_BR_IDX 1
#define Set_BR_Servo(_v) { \
  actuators[SERVO_BR_IDX] = Chop(_v, SERVO_BR_MIN, SERVO_BR_MAX); \
  ActuatorPwmSet(SERVO_BR, actuators[SERVO_BR_IDX]); \
}

#define SERVO_FR_IDX 0
#define Set_FR_Servo(_v) { \
  actuators[SERVO_FR_IDX] = Chop(_v, SERVO_FR_MIN, SERVO_FR_MAX); \
  ActuatorPwmSet(SERVO_FR, actuators[SERVO_FR_IDX]); \
}

#define ACTUATORS_NB 4

#define AllActuatorsInit() { \
  ActuatorsPwmInit();\
}

#define AllActuatorsCommit() { \
  ActuatorsPwmCommit();\
}

#define SetActuatorsFromCommands(values, AP_MODE) { \
  int32_t servo_value;\
  int32_t command_value;\
\
  motor_mixing_run(autopilot_motors_on,FALSE,values); \
\
  command_value = motor_mixing.commands[MOTOR_FRONT_RIGHT]; \
  command_value *= command_value>0 ? SERVO_FR_TRAVEL_UP_NUM : SERVO_FR_TRAVEL_DOWN_NUM; \
  command_value /= command_value>0 ? SERVO_FR_TRAVEL_UP_DEN : SERVO_FR_TRAVEL_DOWN_DEN; \
  servo_value = SERVO_FR_NEUTRAL + command_value; \
  Set_FR_Servo(servo_value); \
\
  command_value = motor_mixing.commands[MOTOR_BACK_RIGHT]; \
  command_value *= command_value>0 ? SERVO_BR_TRAVEL_UP_NUM : SERVO_BR_TRAVEL_DOWN_NUM; \
  command_value /= command_value>0 ? SERVO_BR_TRAVEL_UP_DEN : SERVO_BR_TRAVEL_DOWN_DEN; \
  servo_value = SERVO_BR_NEUTRAL + command_value; \
  Set_BR_Servo(servo_value); \
\
  command_value = motor_mixing.commands[MOTOR_BACK_LEFT]; \
  command_value *= command_value>0 ? SERVO_BL_TRAVEL_UP_NUM : SERVO_BL_TRAVEL_DOWN_NUM; \
  command_value /= command_value>0 ? SERVO_BL_TRAVEL_UP_DEN : SERVO_BL_TRAVEL_DOWN_DEN; \
  servo_value = SERVO_BL_NEUTRAL + command_value; \
  Set_BL_Servo(servo_value); \
\
  command_value = motor_mixing.commands[MOTOR_FRONT_LEFT]; \
  command_value *= command_value>0 ? SERVO_FL_TRAVEL_UP_NUM : SERVO_FL_TRAVEL_DOWN_NUM; \
  command_value /= command_value>0 ? SERVO_FL_TRAVEL_UP_DEN : SERVO_FL_TRAVEL_DOWN_DEN; \
  servo_value = SERVO_FL_NEUTRAL + command_value; \
  Set_FL_Servo(servo_value); \
\
  AllActuatorsCommit(); \
}

#define SECTION_IMU 1
#define IMU_BODY_TO_IMU_PHI 3.14159265
#define IMU_BODY_TO_IMU_THETA 0.
#define IMU_BODY_TO_IMU_PSI 0.

#define SECTION_STABILIZATION_RATE 1
#define STABILIZATION_RATE_SP_MAX_P 2.44346095
#define STABILIZATION_RATE_SP_MAX_Q 2.44346095
#define STABILIZATION_RATE_SP_MAX_R 2.44346095
//#define STABILIZATION_RATE_SP_MAX_R 10.44346095
#define STABILIZATION_RATE_DEADBAND_P 20
#define STABILIZATION_RATE_DEADBAND_Q 20
#define STABILIZATION_RATE_DEADBAND_R 200
#define STABILIZATION_RATE_REF_TAU 4
#define STABILIZATION_RATE_GAIN_P 400
#define STABILIZATION_RATE_GAIN_Q 400
#define STABILIZATION_RATE_GAIN_R 350
//#define STABILIZATION_RATE_GAIN_R 600
#define STABILIZATION_RATE_IGAIN_P 75
#define STABILIZATION_RATE_IGAIN_Q 75
#define STABILIZATION_RATE_IGAIN_R 50
#define STABILIZATION_RATE_DDGAIN_P 300
#define STABILIZATION_RATE_DDGAIN_Q 300
#define STABILIZATION_RATE_DDGAIN_R 300

#define SECTION_STABILIZATION_ATTITUDE 1
#define STABILIZATION_ATTITUDE_SP_MAX_PHI 0.7853981625
#define STABILIZATION_ATTITUDE_SP_MAX_THETA 0.7853981625
#define STABILIZATION_ATTITUDE_SP_MAX_R 1.570796325
//#define STABILIZATION_ATTITUDE_SP_MAX_R 3.5
#define STABILIZATION_ATTITUDE_DEADBAND_A 0
#define STABILIZATION_ATTITUDE_DEADBAND_E 0
#define STABILIZATION_ATTITUDE_DEADBAND_R 250
#define STABILIZATION_ATTITUDE_REF_OMEGA_P 6.981317
#define STABILIZATION_ATTITUDE_REF_ZETA_P 0.85
#define STABILIZATION_ATTITUDE_REF_MAX_P 6.981317
#define STABILIZATION_ATTITUDE_REF_MAX_PDOT RadOfDeg(8000.)
#define STABILIZATION_ATTITUDE_REF_OMEGA_Q 6.981317
#define STABILIZATION_ATTITUDE_REF_ZETA_Q 0.85
#define STABILIZATION_ATTITUDE_REF_MAX_Q 6.981317
#define STABILIZATION_ATTITUDE_REF_MAX_QDOT RadOfDeg(8000.)
#define STABILIZATION_ATTITUDE_REF_OMEGA_R 4.363323125
#define STABILIZATION_ATTITUDE_REF_ZETA_R 0.85
#define STABILIZATION_ATTITUDE_REF_MAX_R 3.14159265
#define STABILIZATION_ATTITUDE_REF_MAX_RDOT RadOfDeg(1800.)
#define STABILIZATION_ATTITUDE_PHI_PGAIN 1000
#define STABILIZATION_ATTITUDE_PHI_DGAIN 400
#define STABILIZATION_ATTITUDE_PHI_IGAIN 200
#define STABILIZATION_ATTITUDE_THETA_PGAIN 1000
#define STABILIZATION_ATTITUDE_THETA_DGAIN 400
#define STABILIZATION_ATTITUDE_THETA_IGAIN 200
#define STABILIZATION_ATTITUDE_PSI_PGAIN 500
//#define STABILIZATION_ATTITUDE_PSI_PGAIN 1000
#define STABILIZATION_ATTITUDE_PSI_DGAIN 300
#define STABILIZATION_ATTITUDE_PSI_IGAIN 10
//#define STABILIZATION_ATTITUDE_PSI_IGAIN 100
#define STABILIZATION_ATTITUDE_PHI_DDGAIN 300
#define STABILIZATION_ATTITUDE_THETA_DDGAIN 300
#define STABILIZATION_ATTITUDE_PSI_DDGAIN 300


#define SECTION_STABILIZATION_ATTITUDE_INDI 1
#define STABILIZATION_INDI_G1_P 0.032
#define STABILIZATION_INDI_G1_Q 0.025
#define STABILIZATION_INDI_G1_R 0.0032
#define STABILIZATION_INDI_G2_R 0.16
#define STABILIZATION_INDI_REF_ERR_P 380.0
#define STABILIZATION_INDI_REF_ERR_Q 380.0
#define STABILIZATION_INDI_REF_ERR_R 250.0
#define STABILIZATION_INDI_REF_RATE_P 21.6
#define STABILIZATION_INDI_REF_RATE_Q 21.6
#define STABILIZATION_INDI_REF_RATE_R 21.0
#define STABILIZATION_INDI_FILT_OMEGA 20.0
#define STABILIZATION_INDI_FILT_ZETA 0.55
#define STABILIZATION_INDI_FILT_OMEGA_R 20.0
#define STABILIZATION_INDI_FILT_ZETA_R 0.55
#define STABILIZATION_INDI_ACT_DYN_P 0.06
#define STABILIZATION_INDI_ACT_DYN_Q 0.06
#define STABILIZATION_INDI_ACT_DYN_R 0.06
#define STABILIZATION_INDI_USE_ADAPTIVE FALSE
#define STABILIZATION_INDI_ADAPTIVE_MU 0.0001


/*
#define SECTION_GUIDANCE_V 1
#define GUIDANCE_V_HOVER_KP 150
#define GUIDANCE_V_HOVER_KD 80
#define GUIDANCE_V_HOVER_KI 20
#define GUIDANCE_V_NOMINAL_HOVER_THROTTLE 0.5
#define GUIDANCE_V_ADAPT_THROTTLE_ENABLED TRUE
*/

#define SECTION_GUIDANCE_V 1
#define GUIDANCE_V_HOVER_KP 283
#define GUIDANCE_V_HOVER_KD 82
#define GUIDANCE_V_HOVER_KI 13
#define GUIDANCE_V_NOMINAL_HOVER_THROTTLE 0.655
#define GUIDANCE_V_ADAPT_THROTTLE_ENABLED FALSE

#define SECTION_GUIDANCE_H 1
#define GUIDANCE_H_MAX_BANK 0.34906585
#define GUIDANCE_H_USE_SPEED_REF TRUE
#define GUIDANCE_H_PGAIN 50
#define GUIDANCE_H_DGAIN 100
#define GUIDANCE_H_AGAIN 70
#define GUIDANCE_H_IGAIN 20

#define SECTION_AUTOPILOT 1
/*
#define MODE_MANUAL AP_MODE_RATE_DIRECT
#define MODE_AUTO1 AP_MODE_ATTITUDE_DIRECT
#define MODE_AUTO2 AP_MODE_HOVER_Z_HOLD
*/
#define MODE_MANUAL AP_MODE_ATTITUDE_RC_CLIMB
#define MODE_AUTO1 AP_MODE_ATTITUDE_DIRECT
#define MODE_AUTO2 AP_MODE_ATTITUDE_Z_HOLD

#define SECTION_BAT 1
#define CATASTROPHIC_BAT_LEVEL 9.3
#define CRITIC_BAT_LEVEL 9.6
#define LOW_BAT_LEVEL 10.1
#define MAX_BAT_LEVEL 12.4
#define MILLIAMP_AT_FULL_THROTTLE 30000

#endif // AIRFRAME_H
